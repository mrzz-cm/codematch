language: node_js
node_js: "12"

services: mongod
addons:
  apt:
    sources:
      - sourceline: 'deb http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/4.2 multiverse'
        key_url: 'https://www.mongodb.org/static/pgp/server-4.2.asc'
    packages:
      - mongodb-org
      - mongodb-org-server
      - mongodb-org-shell
      - mongodb-org-mongos
      - mongodb-org-tools

matrix:
    include:
        - env: 
          - SUB_WORKING_DIRECTORY=backend
          - MODE=test
          script:
            - npm test
            - npm run lint
        - sudo: required
          env:
            - SUB_WORKING_DIRECTORY=frontend
            - MODE=test
            - ANDROID_API_LEVEL=29
            - ANDROID_BUILD_TOOLS_VERSION=29.0.0
            - ANDROID_SDK_TOOLS=sdk-tools-linux-4333796.zip
            - PATH=$ANDROID_HOME:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
          components:
            - tools
            - platform-tools
            - android-tools-adb
            - build-tools-29.0.0
            - android-29
            - doc-29
          install:
            - cd $TRAVIS_BUILD_DIR/backend && npm install
            # list installed and available packages
            - sdkmanager --list || true
            # latest SDK Platform-Tools
            - yes | sdkmanager "platform-tools" >/dev/null
            # defined SDK Platform
            - yes | sdkmanager "platforms;android-$ANDROID_API_LEVEL" >/dev/null
            # defined SDK Build-Tools
            - yes | sdkmanager "build-tools;$ANDROID_BUILD_TOOLS_VERSION" >/dev/null
            - echo yes | sdkmanager "tools"
            - echo yes | sdkmanager "emulator"
            # Install the system image.
            - sdkmanager "system-images;android-24;default;armeabi-v7a"
            # Create and start emulator for the script. Meant to race the install task.
            - echo no | avdmanager create avd --force -n emulatorApi24 -k "system-images;android-24;default;armeabi-v7a"
            - $ANDROID_HOME/emulator/emulator -avd emulatorApi24 -no-audio -no-window &
#             - android-wait-for-emulator
            - adb wait-for-device
            - adb remount
          script:
            - |
              node "$TRAVIS_BUILD_DIR/backend/bin/www" &
              SERVER_PID=$!
              export SERVER_PID=$SERVER_PID
            - chmod +x $TRAVIS_BUILD_DIR/frontend/gradlew
            - cd $TRAVIS_BUILD_DIR/frontend && ./gradlew connectedAndroidTest
            - kill $SERVER_PID
          licenses:
            - '.+'

before_install:
  - if [ "$SUB_WORKING_DIRECTORY" = "backend" ]; then
        ./scripts/mongosetup.sh;
    else
        ./scripts/android_before_install.sh;
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64;
        export PATH="${PATH}:${HOME}/sdk/tools/bin";
        export ANDROID_HOME="${HOME}/sdk";
    fi
  - cp "$TRAVIS_BUILD_DIR/backend/config.js.example" "$TRAVIS_BUILD_DIR/backend/config.js"
  - cd "$TRAVIS_BUILD_DIR/$SUB_WORKING_DIRECTORY"
